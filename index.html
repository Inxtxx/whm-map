<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>WHM 集签地图 · 官方岗位热度（近10天）</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
  html,body{height:100%;margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,"PingFang SC","Microsoft YaHei",sans-serif;}
  #map{width:100%;height:100%;}
  .panel{position:absolute;z-index:1000;background:rgba(255,255,255,.96);padding:10px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.2);max-width:360px}
  .tools{top:10px;left:10px}
  .jobs{top:10px;right:10px}
  .pill{display:inline-block;background:#eef1f6;border-radius:999px;padding:2px 8px;margin:2px 6px 0 0;font-size:12px}
  .legend{position:absolute;z-index:1000;left:10px;bottom:10px;background:#fff;padding:10px;border-radius:6px;box-shadow:0 1px 6px rgba(0,0,0,.18);font-size:13px;line-height:1.5}
  .swatch{width:16px;height:16px;margin-right:8px;border-radius:3px;display:inline-block;border:1px solid #9992}
  .note{font-size:12px;color:#555;margin-top:6px}
</style>
</head>
<body>
<div id="map"></div>

<div class="panel tools">
  <div style="font-weight:600;margin-bottom:4px;">显示选项</div>
  <label><input type="checkbox" id="toggleEligibleOnly" /> 只看可集签</label><br/>
  <label><input type="checkbox" id="toggleCapitals" checked /> 高亮首府（多为不可计入）</label>
  <div class="note">蓝色深浅=Workforce Australia 近10天岗位数量；灰+红虚线=不可集签。</div>
</div>

<div class="panel jobs" id="jobs" style="display:none;">
  <div id="jobsTitle" style="font-weight:600;margin-bottom:6px;"></div>
  <div id="jobsMeta" style="margin-bottom:8px;"></div>
  <div><a id="wfLink" href="#" target="_blank" rel="noopener">在 Workforce Australia 打开检索</a></div>
  <div class="note">岗位来源：Workforce Australia（政府官方）。</div>
</div>

<div class="legend">
  <div style="font-weight:600;margin-bottom:4px;">蓝色=近10天岗位数</div>
  <div><span class="swatch" style="background:#eef5ff;border-color:#cbd6f1"></span>0</div>
  <div><span class="swatch" style="background:#cfe1ff;border-color:#98b7f3"></span>1–5</div>
  <div><span class="swatch" style="background:#9fc2ff;border-color:#6d9ef1"></span>6–20</div>
  <div><span class="swatch" style="background:#6aa0ff;border-color:#447fe6"></span>21–50</div>
  <div><span class="swatch" style="background:#2f6bff;border-color:#1d4ed8"></span>51–100</div>
  <div><span class="swatch" style="background:#0f3bb3;border-color:#0b2a80"></span>100+</div>
  <div style="margin:6px 0;border-top:1px dashed #ccc"></div>
  <div><span class="swatch" style="background:#f2f3f5;border:1px dashed #ff4d4f"></span><span style="color:#c0392b">不可集签</span></div>
  <div class="note">邮编边界：ABS POA 2021（邮政区近似）。</div>
</div>

<script>
// —— 1) 颜色映射（统一蓝色）——
function blueRamp(n){
  if(n<=0) return '#eef5ff';
  if(n<=5) return '#cfe1ff';
  if(n<=20) return '#9fc2ff';
  if(n<=50) return '#6aa0ff';
  if(n<=100) return '#2f6bff';
  return '#0f3bb3';
}
const STYLE_INELIG = { fillColor:'#f2f3f5', color:'#ff4d4f', weight:1, dashArray:'4 2', fillOpacity:.5 };

// —— 2) 载入规则与数据 —— 
const POA_GEOJSON_URL = 'https://cdn.jsdelivr.net/gh/ferocia/australia-geojsons@master/outputs/au-postcodes-Visvalingam-5.geojson';
let rules = null, counts = null;

function getPostcode(props){
  const keys = ['postcode','POA_CODE21','POA_CODE','poa_code','code','id','name'];
  for (const k of keys){
    const v = props[k]; if(!v) continue;
    const m = String(v).match(/\b(\d{4})\b/);
    if (m) return m[1];
  }
  return null;
}

// 简化版：按规则判断某邮编是否可集签 & 显示行业标签
function industriesFor(pc){
  if(!rules) return [];
  const st = rules.stateByPc[pc] || null;
  const ret = [];
  const isRemote = rules.remote.includes(pc) || rules.northern.includes(pc);
  if(isRemote) ret.push('旅游和酒店业');
  const regOK = rules.regionalAllStates.includes(st) || (rules.regionalByState[st]||[]).some(r=>pc>=r[0] && pc<=r[1]);
  if(regOK) ret.push('植畜与动物种植','渔业和珍珠养殖','树木种植与伐木','矿业','建筑业');
  return [...new Set(ret)];
}

function buildWFLink(pc){
  // 官方说明：可用“关键词/位置（邮编或城镇）”搜索。这里用邮编直搜，交给用户在站内再选“Past 2 weeks/Date posted”等筛选。:contentReference[oaicite:5]{index=5}
  return `https://www.workforceaustralia.gov.au/individuals/jobs/search?searchText=${encodeURIComponent(pc)}`;
}

async function init(){
  const map = L.map('map',{preferCanvas:true}).setView([-25.27,133.77], 4);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:12,attribution:'&copy; OpenStreetMap contributors'}).addTo(map);

  // 首府提示层
  const caps=[['Sydney',-33.8688,151.2093],['Melbourne',-37.8136,144.9631],['Brisbane',-27.4698,153.0251],['Perth',-31.9523,115.8613],['Adelaide',-34.9285,138.6007],['Hobart',-42.8821,147.3272],['Darwin',-12.4634,130.8456],['Canberra',-35.2809,149.1300]];
  const capLayer=L.layerGroup(caps.map(x=>L.marker([x[1],x[2]],{interactive:false}).bindTooltip(`⚠️ ${x[0]}（首府，多为不可计入）`,{permanent:true,direction:'right',offset:[8,0]}))).addTo(map);
  document.getElementById('toggleCapitals').onchange=e=>{ if(e.target.checked) capLayer.addTo(map); else map.removeLayer(capLayer); };

  // 载入规则与岗位计数
  [rules, counts] = await Promise.all([
    fetch('rules/eligibility.json').then(r=>r.json()),
    fetch('data/jobs-last10d.json').then(r=>r.json()).catch(()=>({generatedAt:null,countsByPostcode:{}}))
  ]);

  // 载入 POA
  const layer = L.geoJSON(await fetch(POA_GEOJSON_URL).then(r=>r.json()), {
    style: f=>{
      const pc=getPostcode(f.properties);
      const inds=pc?industriesFor(pc):[];
      if(!inds.length) return STYLE_INELIG;
      const n = (counts.countsByPostcode||{})[pc]||0;
      return { fillColor: blueRamp(n), color:'#666', weight:.6, fillOpacity:.65 };
    },
    onEachFeature: (f, poly)=>{
      const pc=getPostcode(f.properties);
      const inds=pc?industriesFor(pc):[];
      const n=(counts.countsByPostcode||{})[pc]||0;
      poly.on('mouseover', e=>{
        poly.setStyle({weight:1.2});
        const html=`
          <div style="font-weight:600;margin-bottom:4px;">邮编 ${pc||'未知'}</div>
          <div>${inds.length? '可集签行业：'+inds.map(i=>`<span class="pill">${i}</span>`).join(' ') : '<span style="color:#c0392b">不可集签区域</span>'}</div>
          <div style="margin-top:6px;">近10天岗位数：<b>${n}</b></div>`;
        poly.bindTooltip(html,{sticky:true,opacity:.96,direction:'top',offset:[0,-4]}).openTooltip(e.latlng);
      });
      poly.on('mouseout', ()=>poly.setStyle({weight:.6}));
      poly.on('click', ()=>{
        const box=document.getElementById('jobs'); box.style.display='block';
        document.getElementById('jobsTitle').innerHTML=`邮编 <b>${pc}</b>`;
        document.getElementById('jobsMeta').innerHTML = `${inds.length? '可集签行业：'+inds.map(i=>`<span class="pill">${i}</span>`).join(' ') : '<span style="color:#c0392b">不可集签区域</span>'} · 近10天岗位：<b>${n}</b>`;
        document.getElementById('wfLink').href=buildWFLink(pc);
        poly.bringToFront();
      });
    }
  }).addTo(map);

  // “只看可集签”
  document.getElementById('toggleEligibleOnly').onchange=e=>{
    const only=e.target.checked;
    layer.setStyle(f=>{
      const pc=getPostcode(f.properties);
      const inds=pc?industriesFor(pc):[];
      if(only && !inds.length) return {opacity:0,fillOpacity:0};
      if(!inds.length) return STYLE_INELIG;
      const n=(counts.countsByPostcode||{})[pc]||0;
      return { fillColor:blueRamp(n), color:'#666', weight:.6, fillOpacity:.65 };
    });
  };
}
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
